---
# This playbook launches a VM on a second vCenter and DC, and configures a uEPG for it.
# It then installs the demo PHP app and customizes it for a new version.
# Finally, we update the HAProxy LB Configuration.
#
- name: install web application
  hosts: web-vm
  gather_facts: yes
  become: true

  vars_files:
    - ./vars/general_vars.yml
    - ./vars/vcenter-info2.yml

  roles:
  - { role: "install-app" }

  tasks: 
  - name: copy new version of the application
    copy:
       src: ./files/myapp-new.php
       dest: /var/www/html/app-new.php
       owner: root
       group: root
       mode: 0644 

  - name: copy new version of the application gif
    copy:
       src: ./files/giphy.gif
       dest: /var/www/html/giphy.gif
       owner: root
       group: root
       mode: 0644

- name: update LB configuration and restart it
  hosts: haproxy
  gather_facts: yes
  become: true
  
  vars_files:
    - ./vars/general_vars.yml
    - ./vars/vcenter-info.yml

  tasks:
  - name: update LB configuration
    shell: "echo '    server web4 10.40.40.14:80 check' >> /etc/haproxy/haproxy.cfg"

  - name: restart HAProxy
    systemd:
       name: haproxy
       state: restarted

